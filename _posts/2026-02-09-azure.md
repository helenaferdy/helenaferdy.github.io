---
title: Azure
date: 2026-02-09 07:30:00 +0700
categories: [Cloud, Azure]
tags: [Azure]
---

Microsoft Azure is a comprehensive cloud computing platform provided by Microsoft that offers over 200 products and services, ranging from virtualized compute and storage to advanced AI and networking. In this lab, we will deploy a FortiGate firewall virtual appliance using a custom VHD image. We will configure multi-interface networking and use User-Defined Routes (UDRs) to ensure that all traffic from an internal Linux host is inspected by our firewall before reaching the internet.

![x](/static/2026-02-09-azure/00.png)

<br>

## Resource Group

First we setup our Azure Account

![x](/static/2026-02-09-azure/01.png)

<br>

Next we configure Resource Group, Resource Group is a logical container that holds related Azure resources (VMs, networks, storage, databases) together.

![x](/static/2026-02-09-azure/02.png)

<br>

Create a new RG with the specified region

![x](/static/2026-02-09-azure/03.png)

![x](/static/2026-02-09-azure/04.png)

<br>

## Creating VM Image

Next we will upload .VHD Fortigate Image that we will later use to deploy a VM. First lets create a Storage Account

![x](/static/2026-02-09-azure/05.png)

<br>

Give it a unique name and some parameters, leave the rest as defaults and hit create

![x](/static/2026-02-09-azure/06.png)

![x](/static/2026-02-09-azure/07.png)

<br>

Now move into the created Storage Account and create a new Container, we'll upload our Image into this 'imagez' container

![x](/static/2026-02-09-azure/08.png)

<br>

Next download the actual VM image from Fortinet's website

![x](/static/2026-02-09-azure/09.png)

<br>

Azure is strict about VHD formats. If we use a standard dynamic disk, weâ€™ll hit the "Conectix" cookie error. We solve this by converting the image to a Fixed-size VHD aligned to a 1MB

```
qemu-img convert -f vpc -O vpc -o subformat=fixed,force_size fortios-old.vhd fortios.vhd
```

<br>

And upload it to the container as 'page blob'

![x](/static/2026-02-09-azure/10.png)

![x](/static/2026-02-09-azure/11.png)

<br>

At this point, we could create a VM image directly. However, Azure may provision the image with a legacy SCSI-based disk controller instead of NVMe, which can limit compatibility with newer VM sizes that require NVMe storage. To address this, we will use an Azure Compute Gallery to create and distribute the image with modern disk controller support.

![x](/static/2026-02-09-azure/12.png)

<br>

Here we create a new Compute Gallery named 'computegallery'

![x](/static/2026-02-09-azure/13.png)

<br>

Next open the computegallery and add VM Image Definition

![x](/static/2026-02-09-azure/14.png)

<br>

Here we create our Fortigate Image Definition, ensure NVMe with Gen 2 VM generation are selected

![x](/static/2026-02-09-azure/14a.png)

<br>

After that open the Image Definition select Add Version

![x](/static/2026-02-09-azure/14b.png)

<br>

Here we select the VHD that we uploaded earlier, this should conclude our VM Image Creation

![x](/static/2026-02-09-azure/14c.png)

<br>

## Virtual Network

Now we configure the networking, Virtual Network (VNet) is a private network in the cloud that lets Azure resources securely communicate with each other, the internet, and on-premises networks.

![x](/static/2026-02-09-azure/15.png)

<br>

Here we create a new 'zelena-vnet'

![x](/static/2026-02-09-azure/16.png)

<br>

We will allocate two subnets, external and internal, and hit create

![x](/static/2026-02-09-azure/17.png)

<br>

Here we have a vnet with 2 subnets

![x](/static/2026-02-09-azure/18.png)

<br>

## Virtual Machine

Now we can proceed to deploy our Fortigate VM, hit create new Virtual Machine

![x](/static/2026-02-09-azure/19.png)

<br>

We use the fortigate image that we created earlier and select the compute with 1 CPU and 2 GB of RAM

![x](/static/2026-02-09-azure/20.png)

<br>

For Admin account, we have to create new account because the default 'admin' account is practically not usable for initial configs. For inbound/outbound rules we select None because we will manually configure later

![x](/static/2026-02-09-azure/21.png)

<br>

Then select the disk size and type

![x](/static/2026-02-09-azure/22.png)

<br>

On networking, we select the ext subnet as our internet facing interface with new public IP. NIC NSG we will select advanced to create new NSG that we will adjust after this

![x](/static/2026-02-09-azure/23.png)

<br>

Here we have our VM deployed. Shut it down first because we will need to configure the second interface for internal facing

![x](/static/2026-02-09-azure/24.png)

<br>

Back on our vnet, here we can see the automatically created ext interface, we manually create new one for int one

![x](/static/2026-02-09-azure/25.png)

<br>

Give it name and select the int subnet

![x](/static/2026-02-09-azure/26.png)

<br>

And now we have 2 interfaces for both ext and int subnet

![x](/static/2026-02-09-azure/27.png)

<br>

While at it, we also need to enabel IP Forwarding on both interfaces so our Fortigate VM can act as a Router/Firewall that can pass traffic

![x](/static/2026-02-09-azure/28.png)

<br>

Back to our Fortigate VM, select Attach Network Interface and select our newly created fortigate-int

![x](/static/2026-02-09-azure/29.png)

<br>

Now our int interface is also attached

![x](/static/2026-02-09-azure/30.png)

<br>

## Network Security Group

Next we will configure our NSG to allow traffic coming in and out of our VM. Here we configure a simple any-any rules for simplicity

![x](/static/2026-02-09-azure/31.png)

![x](/static/2026-02-09-azure/32.png)

<br>

## Powering On VM

Now that all of our networking configs is done, we can power on the Fortigate VM and access it using Serial Console

![x](/static/2026-02-09-azure/33.png)

<br>

Or we can just access the GUI using the Public IP

![x](/static/2026-02-09-azure/34.png)

![x](/static/2026-02-09-azure/34a.png)

<br>

## Routes

Next we will configure routes so int subnet's traffic is steered to use Fortigate as default gateway

![x](/static/2026-02-09-azure/35.png)

<br>

Here we create a new Route Table named 'internal-routing'

![x](/static/2026-02-09-azure/36.png)

![x](/static/2026-02-09-azure/37.png)

<br>

Enter the 'internal-routing' and and add Default Route that points to the Fortigate's internal IP

![x](/static/2026-02-09-azure/38.png)

<br>

Then associate the routing table to the int subnet

![x](/static/2026-02-09-azure/39.png)

<br>

## Testing

To test our firewall setup, we deploy a linux VM on the int subnet

![x](/static/2026-02-09-azure/40.png)

<br>

Here we can see that our Linux (10.0.2.5) can ping the Fortigate's internal IP and also can access the internet

![x](/static/2026-02-09-azure/41.png)

<br>

On Fortigate's firewall logs, we can also see the logs of our linux server accessing internet through our Fortigate

![x](/static/2026-02-09-azure/42.png)

<br>








